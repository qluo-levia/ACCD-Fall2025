<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Red Flame Handpose with Particles</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@0.6.0/dist/ml5.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background:black; }
  </style>
</head>

<body>
<script>
let video;
let handpose;
let predictions = [];

// 粒子数组
let particles = [];

function setup() {
  createCanvas(640, 480);

  video = createCapture(VIDEO);
  video.size(width, height);
  video.hide();

  handpose = ml5.handpose(video, { flipHorizontal: false }, () => {
    console.log("Handpose ready");
  });

  handpose.on("predict", results => {
    predictions = results;
  });
}

function draw() {
  background(0);

  // 画面镜像
  push();
  translate(width, 0);
  scale(-1, 1);
  image(video, 0, 0, width, height);
  pop();

  if (predictions.length > 0) {
    let hand = predictions[0].landmarks;
    let thumb = hand[4];
    let index = hand[8];

    // 镜像坐标
    let thumbX = width - thumb[0];
    let indexX = width - index[0];
    let thumbY = thumb[1];
    let indexY = index[1];

    let distance = dist(thumbX, thumbY, indexX, indexY);

    if (distance < 60) {
      // 两指靠近 → 一个大火球
      let centerX = (thumbX + indexX) / 2;
      let centerY = (thumbY + indexY) / 2;
      drawRedFlame(centerX, centerY, true);
    } else {
      // 分开 → 两个小火焰
      drawRedFlame(thumbX, thumbY, false);
      drawRedFlame(indexX, indexY, false);
    }
  }

  // 更新并绘制粒子
  for (let i = particles.length - 1; i >= 0; i--) {
    particles[i].update();
    particles[i].show();
    if (particles[i].alpha <= 0) {
      particles.splice(i, 1);
    }
  }
}

function drawRedFlame(x, y, big = false) {
  noStroke();
  blendMode(ADD);

  let sizeBase = big ? 120 : 70;

  for (let i = 0; i < 6; i++) {
    fill(255, 40, 30, 40 - i * 6);
    ellipse(x, y, sizeBase + i * 25);
  }

  fill(255, 80, 50, 220);
  ellipse(x, y - 5 + random(-2, 2), sizeBase/2, sizeBase*0.8);

  fill(255, 140, 60, 180);
  ellipse(x, y + random(-6, 6), sizeBase/3, sizeBase/2);

  // 生成周围飘散粒子
  let pCount = big ? 8 : 4;
  for (let i = 0; i < pCount; i++) {
    particles.push(new FlameParticle(x + random(-20, 20), y + random(-20, 20)));
  }

  blendMode(BLEND);
}

// 火焰粒子类
class FlameParticle {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.vx = random(-0.5, 0.5);
    this.vy = random(-1.5, -0.5);
    this.alpha = random(100, 200);
    this.size = random(5, 12);
  }

  update() {
    this.x += this.vx;
    this.y += this.vy;
    this.alpha -= 3;
  }

  show() {
    noStroke();
    fill(255, 120, 50, this.alpha);
    ellipse(this.x, this.y, this.size);
  }
}
</script>
</body>
</html>
